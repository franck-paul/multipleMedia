"use strict";$((()=>{dotclear.mm_select=dotclear.getData("mm_select"),jsToolBar.prototype.elements.mm_select={type:"button",title:"Multiple image chooser",context:"post",icon:dotclear.mm_select.icon,fn:{},fncall:{},open_url:dotclear.mm_select.open_url,data:{},popup(){window.the_toolbar=this,this.elements.mm_select.data={},window.open(this.elements.mm_select.open_url,"dc_popup","alwaysRaised=yes,dependent=yes,toolbar=yes,height=500,width=760,menubar=no,resizable=yes,scrollbars=yes,status=no")}},jsToolBar.prototype.elements.mm_select.fn.wiki=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fn.xhtml=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fn.wysiwyg=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fn.markdown=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fncall.wiki=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((e,t)=>{if(t.settings?.block){const s=t.settings.block+(t.settings?.class?` class="${t.settings?.class}"`:"");e.encloseSelection(`///html\n<${s}>\n///\n`,`///html\n</${t.settings.block}>\n///\n`)}Object.values(t.list).forEach((s=>{e.encloseSelection("","",(l=>{const n=l||s.title;let i=`((${e.stripBaseURL(s.src)}|${n}`;return"left"==t.settings.alignment?i+="|L":"right"==t.settings.alignment?i+="|R":"center"==t.settings.alignment?i+="|C":s.description&&(i+="|"),s.title&&(i+=`|${s.title}`),s.description&&(i+=`|${s.description}`),i+="))",t.settings.link?`[${i}|${e.stripBaseURL(s.url)}${n?`||${n}`:""}]\n`:`${i}\n`}))}))}))},jsToolBar.prototype.elements.mm_select.fncall.xhtml=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((e,t)=>{if(t.settings?.block){const s=t.settings.block+(t.settings?.class?` class="${t.settings?.class}"`:"");e.encloseSelection(`<${s}>\n`,`</${t.settings.block}>\n`)}Object.values(t.list).forEach((s=>{e.encloseSelection("","",(l=>{const n=l||s.title;let i=`<img src="${e.stripBaseURL(s.src)}" alt="${n.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`;if("left"==t.settings.alignment?i+=` ${dotclear.mm_select.style.class?"class":"style"}="${dotclear.mm_select.style.left}"`:"right"==t.settings.alignment?i+=` ${dotclear.mm_select.style.class?"class":"style"}="${dotclear.mm_select.style.right}"`:"center"==t.settings.alignment&&(i+=` ${dotclear.mm_select.style.class?"class":"style"}="${dotclear.mm_select.style.center}"`),s.description&&(i+=` title="${s.description.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`),i+=" />",t.settings.link){const t=n?` title="${n.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`:"";return`<a href="${e.stripBaseURL(s.url)}"${t}>${i}</a>`}return`${i}\n`}))}))}))},jsToolBar.prototype.elements.mm_select.fncall.wysiwyg=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((e,t)=>{let s;t.settings?.block&&(s=e.iwin.document.createElement(t.settings.block),t.settings?.class&&s.setAttribute("class",t.settings?.class)),Object.values(t.list).reverse().forEach((l=>{const n=e.getSelectedText()?e.getSelectedText():l.title;if(null==l.src)return;const i=l.description?e.iwin.document.createElement("figure"):null,c=e.iwin.document.createElement("img"),o=l.description?i:c;if("left"==t.settings.alignment?dotclear.mm_select.style.class?o.classList.add(dotclear.mm_select.style.left):(null==o.style.styleFloat?o.style.cssFloat="left":o.style.styleFloat="left",o.style.marginTop=0,o.style.marginRight="1em",o.style.marginBottom="1em",o.style.marginLeft=0):"right"==t.settings.alignment?dotclear.mm_select.style.class?o.classList.add("dotclear.mm_select.style.right"):(null==o.style.styleFloat?o.style.cssFloat="right":o.style.styleFloat="right",o.style.marginTop=0,o.style.marginRight=0,o.style.marginBottom="1em",o.style.marginLeft="1em"):"center"==t.settings.alignment&&(dotclear.mm_select.style.class?o.classList.add(dotclear.mm_select.style.center):l.description?o.style.textAlign="center":(o.style.marginTop=0,o.style.marginRight="auto",o.style.marginBottom=0,o.style.marginLeft="auto",o.style.display="block")),c.src=e.stripBaseURL(l.src),c.setAttribute("alt",n),l.title&&c.setAttribute("title",l.title),l.description){const t=e.iwin.document.createElement("figcaption");t.appendChild(e.iwin.document.createTextNode(l.description)),i.appendChild(c),i.appendChild(t)}if(t.settings.link){const t=e.iwin.document.createElement("a");t.href=e.stripBaseURL(l.url),n&&t.setAttribute("title",n),t.appendChild(o),void 0===s?e.insertNode(t):s.appendChild(t)}else void 0===s?e.insertNode(o):s.appendChild(o)})),void 0!==s&&e.insertNode(s)}))},jsToolBar.prototype.elements.mm_select.fncall.markdown=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((e,t)=>{if(t.settings?.block){const s=t.settings.block+(t.settings?.class?` class="${t.settings?.class}"`:"");e.encloseSelection(`<${s}>\n`,`</${t.settings.block}>\n`)}Object.values(t.list).forEach((s=>{e.encloseSelection("","",(l=>{const n={left:dotclear.mm_select.style.left,right:dotclear.mm_select.style.right,center:dotclear.mm_select.style.center},i=(l||s.title).replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;"),c=""!==s.description&&s.description.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;");let o=`<img src="${e.stripBaseURL(s.src)}" alt="${i}"`,a="<figure";const r=c?`<figcaption>${c}</figcaption>\n`:"";if(c&&(o=`${o} title="${c}"`),t.settings.alignment in n&&(c?a=`${a} ${n[t.settings.alignment]}"`:o=`${o} ${n[t.settings.alignment]}"`),o=`${o} />`,a=`${a}>`,t.settings.link){const t=i?` title="${i.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`:"";o=`<a href="${e.stripBaseURL(s.url)}"${t}>${o}</a>`}return c?`${a}\n${o}\n${r}</figure>\n`:`${o}\n`}))}))}))},jsToolBar.prototype.elements.mm_select.title=dotclear.mm_select.title,dotclear.mm_select.getInfos=(e,t,s,l,n)=>(t=JSON.stringify(t),s=JSON.stringify(s),dotclear.jsonServicesPost("getMediaInfos",(e=>{e.ret&&n(l,e.info)}),{path:e,list:t,pref:s}),null)}));
