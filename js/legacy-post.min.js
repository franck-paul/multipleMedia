"use strict";$((()=>{dotclear.mm_select=dotclear.getData("mm_select"),jsToolBar.prototype.elements.mm_select={type:"button",title:"Multiple image chooser",context:"post",icon:dotclear.mm_select.icon,fn:{},fncall:{},open_url:dotclear.mm_select.open_url,data:{},popup(){window.the_toolbar=this,this.elements.mm_select.data={},window.open(this.elements.mm_select.open_url,"dc_popup","alwaysRaised=yes,dependent=yes,toolbar=yes,height=500,width=760,menubar=no,resizable=yes,scrollbars=yes,status=no")}},jsToolBar.prototype.elements.mm_select.fn.wiki=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fn.xhtml=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fn.wysiwyg=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fn.markdown=function(){this.elements.mm_select.popup.call(this)},jsToolBar.prototype.elements.mm_select.fncall.wiki=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((e,t)=>{if(t.settings?.block){const s=t.settings.block+(t.settings?.class?' class="'+t.settings?.class+'"':"");e.encloseSelection(`///html\n<${s}>\n///\n`,`///html\n</${t.settings.block}>\n///\n`)}Object.values(t.list).forEach((s=>{e.encloseSelection("","",(l=>{const n=l||s.title;let i=`((${e.stripBaseURL(s.src)}|${n}`;return"left"==t.settings.alignment?i+="|L":"right"==t.settings.alignment?i+="|R":"center"==t.settings.alignment?i+="|C":s.description&&(i+="|"),s.title&&(i+=`|${s.title}`),s.description&&(i+=`|${s.description}`),i+="))",t.settings.link?`[${i}|${e.stripBaseURL(s.url)}${n?`||${n}`:""}]\n`:`${i}\n`}))}))}))},jsToolBar.prototype.elements.mm_select.fncall.xhtml=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((e,t)=>{if(t.settings?.block){const s=t.settings.block+(t.settings?.class?' class="'+t.settings?.class+'"':"");e.encloseSelection(`<${s}>\n`,`</${t.settings.block}>\n`)}Object.values(t.list).forEach((s=>{e.encloseSelection("","",(l=>{const n=l||s.title;let i=`<img src="${e.stripBaseURL(s.src)}" alt="${n.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`;if("left"==t.settings.alignment?i+=' style="float: left; margin: 0 1em 1em 0;"':"right"==t.settings.alignment?i+=' style="float: right; margin: 0 0 1em 1em;"':"center"==t.settings.alignment&&(i+=' style="margin: 0 auto; display: block;"'),s.description&&(i+=` title="${s.description.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`),i+=" />",t.settings.link){const t=n?` title="${n.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`:"";return`<a href="${e.stripBaseURL(s.url)}"${t}>${i}</a>`}return`${i}\n`}))}))}))},jsToolBar.prototype.elements.mm_select.fncall.wysiwyg=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((t,s)=>{let l;s.settings?.block&&(l=t.iwin.document.createElement(s.settings.block),s.settings?.class&&l.setAttribute("class",s.settings?.class)),Object.values(s.list).reverse().forEach((n=>{const i=t.getSelectedText()?t.getSelectedText():n.title;if(null==n.src)return;const o=n.description?t.iwin.document.createElement("figure"):null,c=t.iwin.document.createElement("img"),a=n.description?o:c;if("left"==s.settings.alignment?(null==a.style.styleFloat?a.style.cssFloat="left":a.style.styleFloat="left",a.style.marginTop=0,a.style.marginRight="1em",a.style.marginBottom="1em",a.style.marginLeft=0):"right"==s.settings.alignment?(null==a.style.styleFloat?a.style.cssFloat="right":a.style.styleFloat="right",a.style.marginTop=0,a.style.marginRight=0,a.style.marginBottom="1em",a.style.marginLeft="1em"):"center"==s.settings.alignment&&(n.description?a.style.textAlign="center":(a.style.marginTop=0,a.style.marginRight="auto",a.style.marginBottom=0,a.style.marginLeft="auto",a.style.display="block")),c.src=t.stripBaseURL(n.src),c.setAttribute("alt",i),n.title&&c.setAttribute("title",n.title),n.description){const s=t.iwin.document.createElement("figcaption");s.appendChild(t.iwin.document.createTextNode(e.description)),o.appendChild(c),o.appendChild(s)}if(s.settings.link){const e=t.iwin.document.createElement("a");e.href=t.stripBaseURL(n.url),i&&e.setAttribute("title",i),e.appendChild(a),void 0===l?t.insertNode(e):l.appendChild(e)}else void 0===l?t.insertNode(a):l.appendChild(a)})),void 0!==l&&t.insertNode(l)}))},jsToolBar.prototype.elements.mm_select.fncall.markdown=function(){const e=this.elements.mm_select.data;if(void 0===e||0===e.list.length)return;dotclear.mm_select.getInfos(e.path,e.list,e.pref,this,((e,t)=>{if(t.settings?.block){const s=t.settings.block+(t.settings?.class?' class="'+t.settings?.class+'"':"");e.encloseSelection(`<${s}>\n`,`</${t.settings.block}>\n`)}Object.values(t.list).forEach((s=>{e.encloseSelection("","",(l=>{const n={left:"float: left; margin: 0 1em 1em 0;",right:"float: right; margin: 0 0 1em 1em;",center:"margin: 0 auto; display: table;"},i=(l||s.title).replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;"),o=""!==s.description&&s.description.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;");let c=`<img src="${e.stripBaseURL(s.src)}" alt="${i}"`,a="<figure";const r=o?`<figcaption>${o}</figcaption>\n`:"";if(o&&(c=`${c} title="${o}"`),t.settings.alignment in n&&(o?a=`${a} style="${n[t.settings.alignment]}"`:c=`${c} style="${n[t.settings.alignment]}"`),c=`${c} />`,a=`${a}>`,t.settings.link){const t=i?` title="${i.replace("&","&amp;").replace(">","&gt;").replace("<","&lt;").replace('"',"&quot;")}"`:"";c=`<a href="${e.stripBaseURL(s.url)}"${t}>${c}</a>`}return o?`${a}\n${c}\n${r}</figure>\n`:`${c}\n`}))}))}))},jsToolBar.prototype.elements.mm_select.title=dotclear.mm_select.title,dotclear.mm_select.getInfos=(e,t,s,l,n)=>($.get("services.php",{f:"getMediaInfos",xd_check:dotclear.nonce,path:e,list:t,pref:s}).done((e=>{if($("rsp[status=failed]",e).length>0)window.console.log("Dotclear REST server error");else{if(Number($("rsp>mm_select",e).attr("ret"))){const t=$("rsp>mm_select",e).attr("data");n(l,JSON.parse(t))}}})).fail(((e,t,s)=>{window.console.log(`AJAX ${t} (status: ${e.status} ${s})`)})).always((()=>{})),null)}));
